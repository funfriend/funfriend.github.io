<!DOCTYPE html>
<html lang="en-us">

<head>
  
    <title>TiDB 介绍 | Give me five</title>
    <meta name="DC.Title" content="TiDB 介绍">
  

  
    <meta name="DC.Date" content="2018/03/20">
  

  
    <meta name="DC.Creator" content="Jiafeng Cao">
  

  
    <meta name="DC.Language" content="en">
  

  
    <meta name="DC.Description" content="介绍 TiDB 的特性，架构等">
  

  
    <meta name="DC.Identifier" content="/posts/intro-to-tidb/">
  

  
    <meta name="keywords" content="tidb,">
  

  

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="stylesheet" href="../../css/fonts.css" />
</head>

    <a class="skip-main" href="#main">Skip to main content</a>
        <nav>
      <h1> Give me five </h1>
      <div>
      
      
      
      
        <a href="../../" title="Home">home</a>
      
      
        <a href="../../posts/" title="Posts">posts</a>
      
      
        <a href="../../notes/" title="Notes">notes</a>
      

      
      
        <a href="../../index.xml" title="RSS">rss</a>
      
      </div>
    </ul>
  </nav>




<main id="main">
<header>
    
        <h1>TiDB 介绍</h1>
    

    
        
            Jiafeng Cao
        
         2018/03/20 
    

    
</header>

<article>


<p><img src="https://pingcap.com/images/blog/sparkontikv.png" alt="TiDB Family" /></p>

<ul class="task-list">
<li><label><input type="checkbox" checked disabled class="task-list-item"> 概览</label></li>
<li><label><input type="checkbox" checked disabled class="task-list-item"> Storage - RocksDB</label></li>
<li><label><input type="checkbox" checked disabled class="task-list-item"> Replication - Raft protocol</label></li>
<li><label><input type="checkbox" checked disabled class="task-list-item"> Schedule - PD</label></li>
<li><label><input type="checkbox" checked disabled class="task-list-item"> SQL Layer</label></li>
<li><label><input type="checkbox" disabled class="task-list-item"> Transaction - 2PC/MVCC</label></li>
<li><label><input type="checkbox" disabled class="task-list-item"> Monitoring - Prometheus &amp;&amp; Grafana</label></li>
</ul>

<hr />

<h2 id="概览">概览</h2>

<p><strong>HBase 出了什么问题</strong></p>

<ul>
<li>可用性差

<ul>
<li>GC</li>
<li>恢复时间长</li>
</ul></li>
<li>无跨行事务 - Mistake of Jeaf Dean

<ul>
<li>决定了它只合适做一个 KV 数据库</li>
</ul></li>
</ul>

<p><strong>需要考虑什么</strong></p>

<ul>
<li>一致性：我们是否需要保证整个系统的线性一致性，还是能容忍短时间的数据不一致，只支持最终一致性。</li>
<li>稳定性：我们能否保证系统 7 x 24 小时稳定运行。系统的可用性是 4 个 9，还有 5 个 9？如果出现了机器损坏等灾难情况，系统能否做的自动恢复。</li>
<li>扩展性：当数据持续增多，能否通过添加机器就自动做到数据再次平衡，并且不影响外部服务。</li>
<li>分布式事务：是否需要提供分布式事务支持，事务隔离等级需要支持到什么程度。</li>
</ul>

<hr />

<p><strong>可用性</strong></p>

<ul>
<li>Rust

<ul>
<li>static language。</li>
<li>no GC。</li>
<li>Memory safe，avoid dangling pointer，memory leak。</li>
<li>Thread safe，no data race。</li>
<li>package manager。</li>
<li>C bindings，zero-cost。</li>
<li>not so easy to learn。</li>
<li>not so many libraries as Java or C++。</li>
</ul></li>
<li>多副本（Raft）

<ul>
<li>数据写入只有<strong>大多数副本节点写入成功</strong>才算成功。</li>
<li>一个副本节点 down，可以切换到其他副本节点。</li>
</ul></li>
</ul>

<p><strong>跨行事务 -</strong> 2PC</p>

<p>基于跨行事务，可以实现 SQL-based 的数据库。</p>

<p><strong>GRPC API</strong></p>

<ul>
<li>Get</li>
<li>Scan</li>
<li>BatchGet</li>
<li>Prewrite</li>
<li>Commit</li>
</ul>

<hr />

<h2 id="数据存储">数据存储</h2>

<p><img src="https://pingcap.com/images/blog/storage-stack1.png" alt="Storage Stack" /></p>

<p><img src="https://pingcap.com/images/blog/key-space.png" alt="Key Space" /></p>

<p><img src="https://pingcap.com/images/blog/storage-stack3.png" alt="Storage Stack3" /></p>

<hr />

<h2 id="数据复制">数据复制</h2>

<h3 id="一致性协议-raft">一致性协议 Raft</h3>

<blockquote>
<p>超级棒的 Slide <a href="http://thesecretlivesofdata.com">http://thesecretlivesofdata.com</a></p>
</blockquote>

<h3 id="raft-in-tikv">Raft in TiKV</h3>

<p><img src="https://pingcap.com/images/blog-cn/tikv-architecture.png" alt="" /></p>

<ul>
<li>每个 Region 有三个副本（Replica），副本之间构成一个 Raft Group。</li>
</ul>

<p>（Replica 分布在不同的 TiKV 节点上，其中 Leader 负责读/写，Follower 负责同步 Leader 发来的 raft log）</p>

<ul>
<li><p>请求到 Region Leader 的写请求的数据通过 Raft 协议，在三个副本之间达成一致。</p></li>

<li><p>整个 KV 空间由许多个 Raft Group 构成。</p></li>
</ul>

<h3 id="关于-cap">关于 CAP</h3>

<blockquote>
<p>Choose Availability or Consistency when Partitioned.</p>
</blockquote>

<ul>
<li>在保证一致性的前提，尽可能的提高可用性。<a href="https://cloudplatform.googleblog.com/2018/01/why-you-should-pick-strong-consistency-whenever-possible.html">why you should pick strong consitency whenever possible - from google cloud blog</a></li>
<li>Raft 可容忍少数节点的离线（宕机或者网络不可达）。</li>
</ul>

<h3 id="容灾">容灾</h3>

<ul>
<li><strong>单机房多副本</strong>，副本在不同节点上。

<ul>
<li>可容忍单节点故障。</li>
<li>事务提交操作没有跨机房日志同步操作，对事务响应时间影响最小。</li>
</ul></li>
<li><strong>同城三机房</strong>，每个机房一个数据副本。

<ul>
<li>可容忍单机房故障。</li>
<li>事务提交操作需要在同城机房间进行日志同步，对事务响应时间影响较小。</li>
</ul></li>
<li><strong>两地三机房</strong>，可以使用3个副本或者5个副本。

<ul>
<li>可容忍单机房故障，亦可容忍存放单机房的城市发生故障。</li>
<li>事务大概率在同城机房间进行日志同步，对事务响应时间影响较小；但一旦同城的两个机房中一个机房发生故障，事务提交就需要跨城日志同步，对事务响应时间影响较大。</li>
</ul></li>
<li><strong>三地三机房</strong>，多使用5个副本。

<ul>
<li>容忍城市级故障。</li>
<li>事务提交操作需要跨城进行日志同步，对事务响应时间影响较大。</li>
</ul></li>
</ul>

<hr />

<h2 id="数据调度">数据调度</h2>

<h3 id="为什么调度">为什么调度</h3>

<p>负载与分布：</p>

<ul>
<li>保证请求均匀分布到节点上。</li>
<li>保证节点存储容量均匀。</li>
<li>保证数据访问热点分布均匀。</li>
<li>保证副本数量不多不少，并且分布在不同机器上。</li>
<li>避免集群 Balance 影响服务。</li>
</ul>

<p>扩容缩容：</p>

<ul>
<li>增加节点以及下线节点后，保证数据均匀分布。</li>
</ul>

<p>数据容灾：</p>

<ul>
<li>少数节点失效后，保证服务正常，以及负载和分布均衡。</li>
<li>跨机房部署时，某个机房掉线后，保证不丢失数据甚至是保证正常服务。</li>
</ul>

<h3 id="调度的基本单元">调度的基本单元</h3>

<ul>
<li>增加一个 Replica</li>
<li>删除一个 Replica</li>
<li>将 Raft Leader 从 一个 Replica 转移到另一个 Replica</li>
</ul>

<h3 id="集群信息收集">集群信息收集</h3>

<p>收集每个TiKV 节点的信息，以及每个 Region 的状信息。</p>

<ul>
<li>节点定时上报的信息。

<ul>
<li>磁盘总量，可用磁盘容量。</li>
<li>包含的 Region Replica 个数。</li>
<li>数据写入速度。</li>
<li>是否过载。</li>
<li>Label 信息。</li>
<li>其他&hellip;</li>
</ul></li>
<li>Region 的 Raft Leader 上报信息。

<ul>
<li>Leader/Follower 所在的节点。</li>
<li>掉线的 Replica 个数。</li>
<li>Region 写入和读取的速度。</li>
<li>其他&hellip;</li>
</ul></li>
</ul>

<p><strong>通过管理接口传递进来的外部信息，做更准确的决策。</strong></p>

<ul>
<li>主动下线某个节点。</li>
<li>主动迁移某些热点 Region。</li>
<li>其他&hellip;</li>
</ul>

<h3 id="调度计划">调度计划</h3>

<ul>
<li><strong>一个 Region 的 Replica 数量正确</strong></li>
<li><strong>一个 Raft Group 中的多个 Replica 不在同一个==位置==</strong></li>
<li><strong>副本在 Store 之间的分布均匀分配</strong></li>
<li><strong>Leader 数量在 Store 之间均匀分配</strong></li>
<li><strong>访问热点数量在 Store 之间均匀分配</strong></li>
<li><strong>各个 Store 的存储空间占用大致相等</strong></li>
<li><strong>控制调度速度，避免影响在线服务</strong></li>
<li>其他。。（可在 PD 中实现自定义的调度策略）</li>
</ul>

<h3 id="调度实现">调度实现</h3>

<ol>
<li>PD 不断的通过 Store 或者 Leader 的心跳包收集信息，获得整个集群的详细数据</li>
<li>每次收到 Region Leader 发来的心跳包时，根据以上信息以及调度策略<strong>==生成调度操作序列==</strong>。</li>
<li>通过心跳包的返回消息，将需要进行的操作返回给 Region Leader，并在后面的心跳包中监测执行结果。</li>
</ol>

<hr />

<h2 id="sql-layer">SQL Layer</h2>

<p><img src="https://pingcap.com/images/blog/sql-kv.png" alt="SQL to Key-Value" /></p>

<p>TiDB 对：</p>

<ul>
<li>每个表分配一个 TableID，</li>
<li>每一个索引都会分配一个 IndexID，</li>
<li>每一行分配一个 RowID（如果表有整数型的 Primary Key，那么会用 Primary Key 的值当做 RowID）</li>
<li>其中 TableID 在整个集群内唯一，IndexID/RowID 在表内唯一，这些 ID 都是 int64 类型</li>
</ul>

<p>Record Data: <code>t_${table_id}_r_${handle}</code> =&gt; <code>${v1}${v2}${..}</code></p>

<p>Uniq Index Data: <code>t_${table_id}_i_${index_id}${v1}${v2}</code>=&gt;<code>${handle}</code></p>

<p>Non-Uniq Index Data: <code>t_${table_id}_i_${index_id}${v1}${v2}${v...}${handle}</code> =&gt; <code>null</code></p>

<hr />

<h2 id="coprocessor">Coprocessor</h2>

<p><img src="images/sql-core-layer.png" alt="img" /></p>

<p>执行计划落地：</p>

<p><img src="images/executors.jpg" alt="img" /></p>

<p><img src="images/expression.jpg" alt="img" /></p>

<hr />

<h2 id="the-future-tidb-3-0-构想">The Future - TiDB 3.0 构想</h2>

<p><img src="images/tidb3.0.jpg" alt="tidb3.0" /></p>

<p><img src="images/tidb3-all.jpg" alt="tidb3-all" /></p>

<h2 id="todo-transaction-2pc-mvcc">TODO: Transaction - 2PC/MVCC</h2>

<h2 id="编码格式">编码格式</h2>

<p>DB</p>

<ul>
<li><code>m + DBs + h + DB:[db_id]</code> =&gt; <code>TiDBInfo</code></li>
<li><code>m + DB:[db_id] + h + Table:[tb_id]</code> =&gt; <code>TiTableInfo</code></li>
</ul>
<div class="highlight"><pre style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">    {
        <span style="color:#fb660a;font-weight:bold">&#34;id&#34;</span>:<span style="color:#0086f7;font-weight:bold">130</span>,
        <span style="color:#fb660a;font-weight:bold">&#34;db_name&#34;</span>:{<span style="color:#fb660a;font-weight:bold">&#34;O&#34;</span>:<span style="color:#0086d2">&#34;global_temp&#34;</span>,<span style="color:#fb660a;font-weight:bold">&#34;L&#34;</span>:<span style="color:#0086d2">&#34;global_temp&#34;</span>},
        <span style="color:#fb660a;font-weight:bold">&#34;charset&#34;</span>:<span style="color:#0086d2">&#34;utf8&#34;</span>,
        <span style="color:#fb660a;font-weight:bold">&#34;collate&#34;</span>:<span style="color:#0086d2">&#34;utf8_bin&#34;</span>,
        <span style="color:#fb660a;font-weight:bold">&#34;state&#34;</span>:<span style="color:#0086f7;font-weight:bold">5</span>
    }</code></pre></div><div class="highlight"><pre style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">    {
       <span style="color:#fb660a;font-weight:bold">&#34;id&#34;</span>: <span style="color:#0086f7;font-weight:bold">42</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;name&#34;</span>: {
          <span style="color:#fb660a;font-weight:bold">&#34;O&#34;</span>: <span style="color:#0086d2">&#34;test&#34;</span>,
          <span style="color:#fb660a;font-weight:bold">&#34;L&#34;</span>: <span style="color:#0086d2">&#34;test&#34;</span>
       },
       <span style="color:#fb660a;font-weight:bold">&#34;charset&#34;</span>: <span style="color:#0086d2">&#34;&#34;</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;collate&#34;</span>: <span style="color:#0086d2">&#34;&#34;</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;cols&#34;</span>: [
          {
             <span style="color:#fb660a;font-weight:bold">&#34;id&#34;</span>: <span style="color:#0086f7;font-weight:bold">1</span>,
             <span style="color:#fb660a;font-weight:bold">&#34;name&#34;</span>: {
                <span style="color:#fb660a;font-weight:bold">&#34;O&#34;</span>: <span style="color:#0086d2">&#34;c1&#34;</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;L&#34;</span>: <span style="color:#0086d2">&#34;c1&#34;</span>
             },
             <span style="color:#fb660a;font-weight:bold">&#34;offset&#34;</span>: <span style="color:#0086f7;font-weight:bold">0</span>,
             <span style="color:#fb660a;font-weight:bold">&#34;origin_default&#34;</span>: <span style="color:#fb660a;font-weight:bold">null</span>,
             <span style="color:#fb660a;font-weight:bold">&#34;default&#34;</span>: <span style="color:#fb660a;font-weight:bold">null</span>,
             <span style="color:#fb660a;font-weight:bold">&#34;type&#34;</span>: {
                <span style="color:#fb660a;font-weight:bold">&#34;Tp&#34;</span>: <span style="color:#0086f7;font-weight:bold">3</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Flag&#34;</span>: <span style="color:#0086f7;font-weight:bold">139</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Flen&#34;</span>: <span style="color:#0086f7;font-weight:bold">11</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Decimal&#34;</span>: <span style="color:#0086f7;font-weight:bold">-1</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Charset&#34;</span>: <span style="color:#0086d2">&#34;binary&#34;</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Collate&#34;</span>: <span style="color:#0086d2">&#34;binary&#34;</span>,
                <span style="color:#fb660a;font-weight:bold">&#34;Elems&#34;</span>: <span style="color:#fb660a;font-weight:bold">null</span>
             },
             <span style="color:#fb660a;font-weight:bold">&#34;state&#34;</span>: <span style="color:#0086f7;font-weight:bold">5</span>,
             <span style="color:#fb660a;font-weight:bold">&#34;comment&#34;</span>: <span style="color:#0086d2">&#34;&#34;</span>
          }
       ],
       <span style="color:#fb660a;font-weight:bold">&#34;index_info&#34;</span>: [],
       <span style="color:#fb660a;font-weight:bold">&#34;fk_info&#34;</span>: <span style="color:#fb660a;font-weight:bold">null</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;state&#34;</span>: <span style="color:#0086f7;font-weight:bold">5</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;pk_is_handle&#34;</span>: <span style="color:#fb660a;font-weight:bold">true</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;comment&#34;</span>: <span style="color:#0086d2">&#34;&#34;</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;auto_inc_id&#34;</span>: <span style="color:#0086f7;font-weight:bold">0</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;max_col_id&#34;</span>: <span style="color:#0086f7;font-weight:bold">4</span>,
       <span style="color:#fb660a;font-weight:bold">&#34;max_idx_id&#34;</span>: <span style="color:#0086f7;font-weight:bold">1</span>
    }</code></pre></div>
<h2 id="代码目录说明">代码目录说明</h2>

<h4 id="structure">structure</h4>

<p>TxStructure 包装 <code>kv.Retriever</code> 和 <code>kv.RetrieverMutator</code> 来操作 <code>string</code>, <code>list</code>, <code>hash</code> 类型。</p>

<h4 id="meta">meta</h4>

<p>Meta: 封装 <code>TxStructure</code> 来操作 meta 相关的信息。
Id Allocator: id genertor 封装。</p>

<h4 id="model">model</h4>

<p>schema, table, index 等数据结构 存入底层 kv 时的 json 格式。</p>

<h4 id="table">table</h4>

<p>table，index， column 相关的抽象，用来操作数据。</p>

<h4 id="tablecodec">tablecodec</h4>

<p>数据编码。</p>

<h4 id="terror">terror</h4>

<p>错误码。</p>

<h4 id="types">types</h4>

<p>mysql 类型封装。</p>

<h4 id="distsql">distsql</h4>

<p>对 <code>kv.Response</code> 的封装。</p>

<ul>
<li>streaming(<code>stream.go</code>)
调用 <code>kv.Response</code> 的 <code>Next</code> 方法，返回的数据是 <code>tipb.StreamResponse</code>(one chunk a time)。</li>
<li>select(<code>distsql.go</code>)
调用 <code>kv.Response</code> 的 <code>Next</code> 方法，返回的数据是 <code>tipb.SelectResponse</code>(many chunk)。</li>
</ul>

<p>TODO:</p>

<ul class="task-list">
<li><label><input type="checkbox" disabled class="task-list-item"> implementation of <code>kv.Response</code></label></li>
</ul>

</article>
</main>

    <footer>
    <hr>
      
  <link rel="stylesheet" href="../../css/vs.min.css">
  <script src="../../js/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  <script>
    
    let elements = document.getElementsByClassName("highlight");
    for (let element_id = 0; element_id < elements.length; element_id++) {
      const element = elements[element_id];
      
      element.firstChild.setAttribute("style", "");
      
      let language = element.firstChild.firstChild.getAttribute("data-lang");
      if (language !== null) {
          element.firstChild.firstChild.setAttribute("class", language);
      }
    }
  </script>

  <script>
    const code = document.querySelectorAll("code");
    [...code].forEach(el => el.textContent = el.textContent.replace(/^\n/,''));
  </script>

      <p>
        Last updated May 08 2021
      </p>
      <p>
        
      </p>
      <br>
    </footer>
  </body>
</html>

